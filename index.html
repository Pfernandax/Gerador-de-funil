<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Gerador de Pipeline de Vendas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg1:#0f1a2b; --bg2:#162941; --card:#0f1b2e; --ink:#e6efff; --ink2:#cfe1ff;
      --muted:#9fb5d1; --ia:#2ed3b7; --human:#6b7bff; --soft:#13233a; --soft2:#223652;
      --brand:#4fbeff; --accent:#6be3c0;
    }
    body{ background: radial-gradient(1200px 800px at 50% -200px, #1b3556 0%, #0d1a2b 55%, #0a1422 100%); font-family:'Montserrat',Arial,sans-serif; min-height:100vh; margin:0; color:var(--ink); }
    .main-title{ text-align:center; font-size:2.2rem; font-weight:800; color:#d8e8ff; margin:32px 0 8px; letter-spacing:-.5px; text-shadow:0 10px 30px #02102488; }

    /* Wizard */
    .center-outer{ min-height:75vh; display:flex; align-items:center; justify-content:center; }
    .form-card-anim-wrapper{ width:520px; max-width:95vw; position:relative; min-height:320px; }
    .form-card{ background:linear-gradient(180deg, #12243b, #0e1c31); width:100%; padding:42px 34px 34px; border-radius:26px; box-shadow:0 10px 40px #00000055,inset 0 0 0 1px #223e677a; position:absolute; left:0; top:0; animation:fadeIn .45s; }
    .form-card.slide-in-left{ animation:slideInLeft .45s cubic-bezier(.75,0,.27,1);} .form-card.slide-in-right{ animation:slideInRight .45s cubic-bezier(.75,0,.27,1);} .form-card.slide-out-left{ animation:slideOutLeft .42s cubic-bezier(.85,0,.14,1);} .form-card.slide-out-right{ animation:slideOutRight .42s cubic-bezier(.85,0,.14,1);} 
    @keyframes slideInLeft{from{opacity:0;transform:translateX(-120px)}to{opacity:1;transform:none}}@keyframes slideInRight{from{opacity:0;transform:translateX(120px)}to{opacity:1;transform:none}}@keyframes slideOutLeft{from{opacity:1;transform:none}to{opacity:0;transform:translateX(-120px)}}@keyframes slideOutRight{from{opacity:1;transform:none}to{opacity:0;transform:translateX(120px)}}@keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:none}}
    .progress-bar{position:absolute;top:0;left:0;width:100%;height:6px;border-radius:6px 6px 0 0;background:#0a1625;overflow:hidden}
    .progress-bar-inner{background:linear-gradient(90deg,#4fbeff 20%,#6be3c0 100%);height:100%;width:0%;transition:width .45s cubic-bezier(.65,0,.35,1)}
    .step-emoji{font-size:30px;margin-bottom:10px;display:block}
    .step-title{font-size:21px;font-weight:800;color:#d5e6ff;margin-bottom:18px;letter-spacing:-.6px}
    .step-tip{font-size:13px;color:#97b6df;margin:12px 0 2px;background:#0c1a2c;border:1px solid #1f3a5d;border-radius:10px;padding:8px 12px;font-weight:600}

    .options label{display:flex;align-items:center;gap:12px;font-size:16px;padding:14px;border-radius:16px;border:1px solid #1f3759;margin-bottom:12px;cursor:pointer;background:#0f1d33;transition:all .18s}
    .options input[type="radio"]:checked + span,.options label:has(input[type="radio"]:checked){background:#0e233d;border:1px solid #2e6ae2;color:#a9c7ff}
    .options input[type="radio"]{accent-color:#4ab9ce;width:22px;height:22px}
    .options select,.options input[type="text"]{font-size:15px;padding:12px;border-radius:12px;border:1px solid #1f3759;width:100%;background:#0f2038;color:#d7e8ff;margin-top:6px}

    .form-btn-row{display:flex;justify-content:space-between;align-items:center;gap:14px;margin-top:22px}
    .step-count{color:#8ab0e8;font-size:.9rem;font-weight:700}
    .next-btn,.prev-btn{font-family:inherit;font-size:16px;font-weight:700;border:none;border-radius:14px;padding:11px 26px;transition:all .21s;cursor:pointer}
    .next-btn{background:linear-gradient(90deg,#4fbeff 30%,#6be3c0 100%);color:#061629;box-shadow:0 5px 25px #5bd9ff26}
    .next-btn[disabled]{background:#0b1a2d;color:#355a86;cursor:not-allowed}
    .next-btn:not([disabled]):hover{transform:translateY(-1px) scale(1.02)}
    .prev-btn{background:#0d1e33;color:#90b9ff;border:1px solid #1f3a5d}
    .prev-btn:hover{background:#0b1930}

    /* Pipeline */
    .pipeline-wrapper{width:98vw;max-width:1160px;margin:24px auto 48px;display:flex;flex-direction:column;align-items:center}
    .pipeline-board{width:100%;display:flex;gap:16px;justify-content:center;margin-bottom:24px;flex-wrap:wrap}
    .pipeline-col{border-radius:18px 18px 14px 14px;min-width:200px;max-width:240px;flex:1 1 210px;box-shadow:0 12px 40px #00000044,inset 0 0 0 1px #24446e;display:flex;flex-direction:column;align-items:center;border-top:6px solid var(--brand);position:relative;background:#0e1d32}
    .col-ia{background:#082a26;border-top-color:var(--ia)!important}
    .col-humano{border-top-color:var(--human)!important}
    .pipeline-col .col-title{font-size:1.02rem;font-weight:800;color:#d6e7ff;margin:0;padding:16px 12px 10px;text-align:center;min-height:54px;display:flex;align-items:center;justify-content:center;gap:9px;position:relative}
    .col-ia .col-title{color:#7ff1dc}
    .col-humano .col-title{color:#b8c3ff}
    .col-actions{position:absolute;right:6px;top:6px;display:flex;gap:6px}
    .icon-btn{background:none;border:none;font-size:16px;cursor:pointer;opacity:.7;color:#9fc2ff}
    .icon-btn:hover{opacity:1;transform:translateY(-1px)}

    .board-toolbar{width:100%;display:flex;flex-direction:column;gap:10px;margin:6px 0 12px;align-items:flex-start}
    .add-col-btn{background:#0c213b;color:#a1d6ff;border:1px solid #214266;border-radius:12px;padding:8px 12px;font-weight:800;cursor:pointer}
    .add-col-form{display:none;width:100%;max-width:520px;background:#0d1d32;border:1px dashed #214266;border-radius:12px;padding:10px}
    .add-col-form .form-row{display:flex;gap:8px}
    .add-col-form input,.add-col-form select{flex:1;font-size:14px;padding:10px;border-radius:10px;border:1px solid #1e3a60;background:#0b1a2d;color:#d3e8ff}
    .add-col-form button{background:#2ed3b7;color:#052b29;border:none;border-radius:10px;padding:8px 14px;font-weight:800;cursor:pointer}
    .add-col-form .cancel{background:#0b1a2d;color:#9ac8ff;border:1px solid #1f3a5d}

    .kanban-cards{width:93%;min-height:32px}
    .kanban-card{background:#0b1a2d;border-radius:12px;margin:8px 0;padding:14px 14px 12px 16px;font-size:15px;color:#cfe1ff;font-weight:600;box-shadow:0 6px 20px #00000040,inset 0 0 0 1px #103054;position:relative;display:flex;flex-direction:column;animation:fadeIn .32s}
    .kanban-card.ia .card-label{color:#2ed3b7;font-size:12px;font-weight:800}
    .kanban-card.humano .card-label{color:#8ea0ff;font-size:12px;font-weight:800}
    .kanban-card.usernote .card-label{color:#ffd17a;font-size:12px}
    .kanban-card .card-delete,.del-note-btn{position:absolute;top:6px;right:10px;background:none;border:none;color:#8aa8d6;font-size:19px;cursor:pointer;line-height:1;opacity:.5}
    .kanban-card .card-delete:hover,.del-note-btn:hover{opacity:1}
    .kanban-add-btn,.add-note-btn{margin-top:12px;width:100%;min-height:44px;border:1px dashed #214266;border-radius:12px;background:#0c1f35;color:#86bfff;font-size:1.6rem;display:flex;align-items:center;justify-content:center;cursor:pointer}

    .pipeline-actions{width:100%;text-align:right;margin-top:10px;display:flex;gap:12px;justify-content:flex-end}
    .pdf-btn,.restart-btn{background:linear-gradient(90deg,#4fbeff 40%,#6be3c0 100%);color:#05182b;border:none;border-radius:14px;padding:11px 22px;font-size:1.02rem;font-weight:800;cursor:pointer}
    .restart-btn{background:#0c213b;color:#9edbff;border:1px solid #214266}

    .pipeline-objetivo{margin:8px 0 16px;color:#b6ceff;font-size:1.05rem}
    .add-note-form{margin:8px 0 0 0;width:94%}
    .add-note-form textarea{width:100%;border-radius:8px;border:1px solid #1e3a60;background:#0b1a2d;color:#cfe1ff;font-size:14px;padding:8px}
    .add-note-form button{margin-top:6px;padding:6px 18px;border:none;border-radius:8px;background:#2ed3b7;color:#052b29;font-weight:800;cursor:pointer}

    @media (max-width:800px){.pipeline-board{flex-direction:column;gap:13px}.pipeline-col{max-width:98vw}}
    @media (max-width:600px){.form-card-anim-wrapper{width:99vw}.form-card{padding:22px 12px 16px}.step-title{font-size:18px}.options label{font-size:15px}}
  </style>
</head>
<body>    
  <div class="main-title">Gerador de Pipeline de Vendas</div>
    <div class="center-outer" id="centerForm">
    <div class="form-card-anim-wrapper" id="wizardWrapper"></div>
  </div>
  <div id="pipelineArea" style="display:none;"></div>

<script>
  // ===== Estado =====
  let userAnswers = {}; let currentPipeline = null; let currentContext = null; // { segmento, usarIA }

  const segmentos = [
    {val:"mediaGeral",txt:"M√©dia Geral"},{val:"agencia",txt:"Ag√™ncia de Marketing/Publicidade"},{val:"consultorias",txt:"Consultorias/Treinamentos"},{val:"ecommerce",txt:"E-commerce"},{val:"educacao",txt:"Educa√ß√£o/Ensino"},{val:"engenharia",txt:"Engenharia/Ind√∫stria"},{val:"eventos",txt:"Eventos"},{val:"financeiro",txt:"Financeiro/Jur√≠dico/Servi√ßos"},{val:"hardware",txt:"Hardware/Eletr√¥nicos"},{val:"imobiliarias",txt:"Imobili√°rias"},{val:"midia",txt:"M√≠dia/Comunica√ß√£o"},{val:"ong",txt:"ONG"},{val:"saude",txt:"Sa√∫de/Est√©tica"},{val:"servicos",txt:"Servi√ßos em Geral"},{val:"rh",txt:"RH/Coaching"},{val:"software",txt:"Software/Cloud"},{val:"telecom",txt:"Telecom"},{val:"turismo",txt:"Turismo/Lazer"},{val:"varejo",txt:"Varejo"}
  ];

  const icons = { ia: "ü§ñ", humano: "üôã‚Äç‚ôÇÔ∏è" };

  // Overrides (mesmos exemplos de antes; encurtados para caber)
  const pipelinesIAOverrides = {
    mediaGeral:[{nome:"Lead Novo",tipo:"ia",cards:["Mensagem 1D: ‚ÄòRecebemos seu contato, obrigado!‚Äô","Mensagem 3D: ‚ÄòPodemos ajudar em algo?‚Äô","Transferir para humano se respondeu"]},{nome:"N√£o Respondeu",tipo:"ia",cards:["Mensagem 7D: ‚ÄòEst√° tudo bem? Seguimos √† disposi√ß√£o.‚Äô"]},{nome:"Em Atendimento",tipo:"humano",cards:["Contato do consultor","Diagn√≥stico da necessidade"]},{nome:"Negocia√ß√£o/Fechamento",tipo:"humano",cards:["Proposta enviada","Negocia√ß√£o","Fechamento"]}],
    agencia:[{nome:"Lead Novo",tipo:"ia",cards:["Mensagem 1D: ‚ÄòOi, tudo bem? Vi seu interesse em marketing‚Ä¶‚Äô","Mensagem 3D: ‚ÄòPodemos marcar uma conversa?‚Äô","Mensagem 7D: ‚ÄòSe quiser, posso enviar cases de sucesso.‚Äô","Transferir para consultor se respondeu"]},{nome:"N√£o Respondeu",tipo:"ia",cards:["Mensagem 14D: ‚ÄòAinda tem interesse em campanhas?‚Äô","Mensagem 28D: ‚ÄòTemos novidades, posso te atualizar?‚Äô","Mensagem 45D: ‚Äò√öltima chamada, ainda te interessa?‚Äô"]},{nome:"Em Atendimento",tipo:"humano",cards:["Consultor liga e agenda briefing","Envia material de portf√≥lio"]},{nome:"Negocia√ß√£o",tipo:"humano",cards:["Proposta personalizada","Negocia√ß√£o com follow-up ativo"]}],
    consultorias:[{nome:"Lead Novo",tipo:"ia",cards:["Mensagem 1D: ‚ÄòObrigado pelo interesse, qual seu desafio?‚Äô","Mensagem 4D: ‚ÄòPrefere online ou presencial?‚Äô","Transferir para especialista se respondeu"]},{nome:"Falta de retorno",tipo:"ia",cards:["Mensagem 7D: ‚ÄòGostaria de agendar um diagn√≥stico?‚Äô","Mensagem 14D: ‚ÄòNossa agenda est√° aberta, posso reservar para voc√™?‚Äô"]},{nome:"Pr√©-Diagn√≥stico",tipo:"humano",cards:["Consultor faz liga√ß√£o","Pr√©-diagn√≥stico gratuito"]},{nome:"Proposta/Fechamento",tipo:"humano",cards:["Apresenta√ß√£o de proposta","Follow-up at√© fechar"]}],
    ecommerce:[{nome:"Carrinho Abandonado",tipo:"ia",cards:["Mensagem 1H: ‚ÄòSeu carrinho est√° esperando!‚Äô","Mensagem 1D: ‚ÄòPrecisa de ajuda para finalizar?‚Äô","Transferir para humano se respondeu"]},{nome:"N√£o respondeu",tipo:"ia",cards:["Mensagem 3D: ‚ÄòAinda est√° interessado? Produto limitado!‚Äô"]},{nome:"Em Atendimento",tipo:"humano",cards:["Atendente tira d√∫vidas","Oferece cupom especial"]},{nome:"P√≥s-venda",tipo:"humano",cards:["Confirma√ß√£o do pedido","Pesquisa de satisfa√ß√£o"]}]
  };
  const pipelinesTradOverrides = {
    mediaGeral:[{nome:"Prospec√ß√£o",tipo:"humano",cards:[]},{nome:"Qualifica√ß√£o",tipo:"humano",cards:[]},{nome:"Apresenta√ß√£o",tipo:"humano",cards:[]},{nome:"Proposta",tipo:"humano",cards:[]},{nome:"Negocia√ß√£o",tipo:"humano",cards:[]},{nome:"Fechamento",tipo:"humano",cards:[]}],
    agencia:[{nome:"Prospec√ß√£o de Leads",tipo:"humano",cards:[]},{nome:"Briefing Inicial",tipo:"humano",cards:[]},{nome:"Diagn√≥stico e Planejamento",tipo:"humano",cards:[]},{nome:"Apresenta√ß√£o de Proposta",tipo:"humano",cards:[]},{nome:"Negocia√ß√£o/Alinhamento",tipo:"humano",cards:[]},{nome:"Aprova√ß√£o do Cliente",tipo:"humano",cards:[]},{nome:"Fechamento",tipo:"humano",cards:[]}],
    ecommerce:[{nome:"Capta√ß√£o de Lead/Visitante",tipo:"humano",cards:[]},{nome:"Engajamento (Ofertas/Newsletter)",tipo:"humano",cards:[]},{nome:"Adi√ß√£o ao Carrinho",tipo:"humano",cards:[]},{nome:"Recupera√ß√£o de Carrinho",tipo:"humano",cards:[]},{nome:"Pagamento Realizado",tipo:"humano",cards:[]},{nome:"P√≥s-venda/Fideliza√ß√£o",tipo:"humano",cards:[]}]
  };

  // Helpers
  const genUid = () => 'c'+Math.random().toString(36).slice(2)+Date.now().toString(36);
  const ensureUids = (p=[]) => p.map(col => ({...col, uid: col.uid || genUid()}));
  function slug(s){
    let t = (s||'').normalize('NFD');
    let out = '';
    for (let ch of t){ const c = ch.charCodeAt(0); if (c>=0x0300 && c<=0x036F) continue; out += ch; }
    out = out.toLowerCase();
    out = out.replace(/[^a-z0-9 -]/g,''); // remove pontua√ß√£o
    out = out.trim().replace(/ +/g,'-');
    return out;
  }

  function baseTemplateDefault(usarIA){
    const ia = usarIA ? 'ia' : 'humano';
    return [
      { nome: usarIA?"Lead novo (captura autom√°tica)":"Lead novo", tipo: usarIA?"ia":"humano", cards: usarIA?["Mensagem 1D de boas-vindas","Mensagem 3D de apoio","Transferir se respondeu"]:["Registrar lead","Dar boas-vindas"] },
      { nome: usarIA?"Qualifica√ß√£o (IA ‚Üí Humano)":"Qualifica√ß√£o", tipo: ia, cards: usarIA?["Perguntas de qualifica√ß√£o","Marcar contato humano se apto"]:["BANT/GPCT","Priorizar"] },
      { nome: "Descoberta/Diagn√≥stico", tipo: "humano", cards: ["Entender dor/necessidade","Mapear decisores"] },
      { nome: "Apresenta√ß√£o/Demo", tipo: "humano", cards: ["Apresentar solu√ß√£o","Validar encaixe"] },
      { nome: "Proposta", tipo: "humano", cards: ["Enviar proposta","Prazo e condi√ß√µes"] },
      { nome: usarIA?"Follow-up Autom√°tico":"Follow-up", tipo: usarIA?"ia":"humano", cards: usarIA?["Lembretes 2D/5D","Reengajamento"]:["Follow-ups peri√≥dicos"] },
      { nome: "Negocia√ß√£o", tipo: "humano", cards: ["Ajustes comerciais","Aprova√ß√£o interna"] },
      { nome: "Fechado ‚Äì Ganho", tipo: "humano", cards: ["Contrato assinado"] },
      { nome: "Fechado ‚Äì Perdido", tipo: "humano", cards: ["Registrar motivo"] },
      { nome: "Onboarding/P√≥s-venda", tipo: "humano", cards: ["Kickoff","NPS inicial"] }
    ];
  }
  function baseTemplateBySegment(segmento, usarIA){
    if(segmento==='ecommerce'){
      return [
        { nome: usarIA?"Lead/Visitante (captura)":"Lead/Visitante", tipo: usarIA?"ia":"humano", cards: usarIA?["Mensagem de boas-vindas","Pergunta de interesse"]:["Capturar email/whats"] },
        { nome: "Engajamento", tipo: usarIA?"ia":"humano", cards: ["Ofertas/Newsletter","D√∫vidas r√°pidas"] },
        { nome: "Adi√ß√£o ao Carrinho", tipo: "humano", cards: ["Suporte √† compra"] },
        { nome: usarIA?"Carrinho Abandonado (IA)":"Recupera√ß√£o de Carrinho", tipo: usarIA?"ia":"humano", cards: usarIA?["Lembrete 1H","Cupom 24H"]:["Contato manual"] },
        { nome: "Checkout/Pagamento", tipo: "humano", cards: ["Confirma√ß√£o de pagamento"] },
        { nome: "Fechado ‚Äì Ganho", tipo: "humano", cards: ["Pedido aprovado"] },
        { nome: "Fechado ‚Äì Perdido", tipo: "humano", cards: ["Motivo de desist√™ncia"] },
        { nome: "P√≥s-venda/Fideliza√ß√£o", tipo: "humano", cards: ["Pesquisa de satisfa√ß√£o","Programa de pontos"] }
      ];
    }
    return baseTemplateDefault(usarIA);
  }
  function mergeAndComplete(base, override){
    if(!override||!Array.isArray(override)) return base;
    const result = [...override.map(o=>({...o}))];
    const namesInOverride = new Set(result.map(s=>slug(s.nome)));
    base.forEach(b=>{ if(!namesInOverride.has(slug(b.nome))) result.push({...b}); });
    const haveSlugs = new Set(result.map(s=>slug(s.nome)));
    if(!haveSlugs.has(slug('Fechado ‚Äì Ganho'))) result.push({nome:'Fechado ‚Äì Ganho',tipo:'humano',cards:['Conclu√≠do com sucesso']});
    if(!haveSlugs.has(slug('Fechado ‚Äì Perdido'))) result.push({nome:'Fechado ‚Äì Perdido',tipo:'humano',cards:['Registrar motivo']});
    const posList = ['Onboarding/P√≥s-venda','P√≥s-venda','Onboarding','P√≥s-viagem','P√≥s-procedimento','P√≥s-matr√≠cula','Execu√ß√£o/P√≥s','Entrega/Instala√ß√£o','Onboarding/Ativa√ß√£o'];
    if(!result.some(s=>posList.map(slug).includes(slug(s.nome)))) result.push({nome:'Onboarding/P√≥s-venda',tipo:'humano',cards:['Kickoff','NPS inicial']});
    return result;
  }
  function buildPipeline(segmento, usarIA){
    const base = baseTemplateBySegment(segmento, usarIA);
    const override = (usarIA?pipelinesIAOverrides:pipelinesTradOverrides)[segmento];
    return ensureUids(mergeAndComplete(base, override));
  }

  // Notas personalizadas por coluna (uid)
  let notasAdicionais = {};

  // ===== Wizard =====
  const steps = [
    { emoji:'üè¢', title:'Para qual segmento vamos criar seu pipeline?', html:`<div class="options">
        <select id="segmento" required>
          <option value="">Escolha o segmento...</option>
          ${segmentos.map(s=>`<option value="${s.val}">${s.txt}</option>`).join('')}
        </select>
      </div>`, tip:'Escolha o setor mais pr√≥ximo do seu neg√≥cio.', validate:()=>document.getElementById('segmento').value!=='' },
    { emoji:'ü§ñ', title:'Deseja um funil com IA ou tradicional?', html:`<div class="options">
        <label><input type="radio" name="usarIA" value="sim"><span>Sim, incluir etapas com IA</span></label>
        <label><input type="radio" name="usarIA" value="nao"><span>N√£o, quero um funil tradicional</span></label>
      </div>`, tip:'A IA pode automatizar etapas e trazer mais produtividade!', validate:()=>!!document.querySelector('input[name="usarIA"]:checked') },
    { emoji:'üíº', title:'Qual √© o principal produto ou servi√ßo que voc√™ oferece?', html:`<div class="options">
        <input type="text" id="produto" placeholder="Descreva seu produto ou servi√ßo principal">
      </div>`, tip:'Ajuda a personalizar seu pipeline.', validate:()=>document.getElementById('produto').value.trim().length>0 },
    { emoji:'üë§', title:'Seu cliente normalmente √© pessoa f√≠sica, jur√≠dica ou ambos?', html:`<div class="options">
        <label><input type="radio" name="tipoCliente" value="Pessoa F√≠sica"><span>Pessoa F√≠sica</span></label>
        <label><input type="radio" name="tipoCliente" value="Pessoa Jur√≠dica"><span>Pessoa Jur√≠dica</span></label>
        <label><input type="radio" name="tipoCliente" value="Ambos"><span>Ambos</span></label>
      </div>`, tip:'Para adaptar a comunica√ß√£o do pipeline.', validate:()=>!!document.querySelector('input[name="tipoCliente"]:checked') },
    { emoji:'üå±', title:'Como voc√™ costuma captar novos leads?', html:`<div class="options">
        <label><input type="checkbox" name="captaLead" value="Indica√ß√£o"> Indica√ß√£o</label>
        <label><input type="checkbox" name="captaLead" value="M√≠dia paga"> M√≠dia paga</label>
        <label><input type="checkbox" name="captaLead" value="Redes sociais"> Redes sociais</label>
        <label><input type="checkbox" name="captaLead" value="Feiras/eventos"> Feiras/eventos</label>
        <label><input type="checkbox" name="captaLead" value="Outro"> Outro</label>
        <input type="text" id="captaOutro" placeholder="Descreva, se outro" style="margin-top:8px;">
      </div>`, tip:'Pode marcar mais de uma op√ß√£o.', validate:()=>{ let c=document.querySelectorAll('input[name="captaLead"]:checked'); return c.length>0||document.getElementById('captaOutro').value.trim().length>0; } },
    { emoji:'ü§î', title:'Qual √© o maior desafio do seu processo comercial hoje?', html:`<div class="options">
        <label><input type="radio" name="desafio" value="Gerar leads"><span>Gerar leads</span></label>
        <label><input type="radio" name="desafio" value="Qualificar leads"><span>Qualificar leads</span></label>
        <label><input type="radio" name="desafio" value="Marcar reuni√µes"><span>Marcar reuni√µes</span></label>
        <label><input type="radio" name="desafio" value="Enviar propostas"><span>Enviar propostas</span></label>
        <label><input type="radio" name="desafio" value="Fechar vendas"><span>Fechar vendas</span></label>
        <label><input type="radio" name="desafio" value="Fazer follow-up"><span>Fazer follow-up</span></label>
        <label><input type="radio" name="desafio" value="Outro"><span>Outro</span></label>
        <input type="text" id="desafioOutro" placeholder="Descreva, se outro" style="margin-top:8px;">
      </div>`, tip:'Escolha o principal desafio atual.', validate:()=>{ let c=document.querySelector('input[name="desafio"]:checked'); return !!c || document.getElementById('desafioOutro').value.trim().length>0; } },
    { emoji:'‚è≥', title:'Qual √© o tempo m√©dio do seu ciclo de vendas (do primeiro contato ao fechamento)?', html:`<div class="options">
        <label><input type="radio" name="ciclo" value="1 dia"><span>1 dia</span></label>
        <label><input type="radio" name="ciclo" value="1 semana"><span>1 semana</span></label>
        <label><input type="radio" name="ciclo" value="2-4 semanas"><span>2-4 semanas</span></label>
        <label><input type="radio" name="ciclo" value="1-3 meses"><span>1-3 meses</span></label>
        <label><input type="radio" name="ciclo" value="+3 meses"><span>+3 meses</span></label>
      </div>`, tip:'Ajuda a sugerir o n√∫mero de etapas e automa√ß√µes.', validate:()=>!!document.querySelector('input[name="ciclo"]:checked') },
    { emoji:'ü§ñ', title:'Voc√™ j√° utiliza mensagens autom√°ticas ou chatbots?', html:`<div class="options">
        <label><input type="radio" name="usaBot" value="Sim"><span>Sim</span></label>
        <label><input type="radio" name="usaBot" value="N√£o"><span>N√£o</span></label>
        <label><input type="radio" name="usaBot" value="Tenho interesse"><span>Tenho interesse</span></label>
      </div>`, tip:'Ajuda a sugerir automa√ß√µes no pipeline.', validate:()=>!!document.querySelector('input[name="usaBot"]:checked') },
    { emoji:'üìä', title:'Como voc√™ mede o sucesso do seu time de vendas?', html:`<div class="options">
        <label><input type="radio" name="sucesso" value="N√∫mero de vendas"><span>N√∫mero de vendas</span></label>
        <label><input type="radio" name="sucesso" value="Propostas enviadas"><span>Propostas enviadas</span></label>
        <label><input type="radio" name="sucesso" value="Taxa de convers√£o"><span>Taxa de convers√£o</span></label>
        <label><input type="radio" name="sucesso" value="Outro"><span>Outro</span></label>
        <input type="text" id="sucessoOutro" placeholder="Descreva, se outro" style="margin-top:8px;">
      </div>`, tip:'A resposta pode ajudar a definir prioridades e automa√ß√µes.', validate:()=>{ let c=document.querySelector('input[name="sucesso"]:checked'); return !!c || document.getElementById('sucessoOutro').value.trim().length>0; } },
    { emoji:'üöÄ', title:'Qual √© o principal objetivo do seu processo de vendas hoje?', html:`<div class="options">
        <input type="text" name="objetivo" id="objetivo" placeholder="Ex: Aumentar volume, reduzir tempo...">
      </div>`, tip:'Defina um objetivo claro. O pipeline te ajuda a chegar l√°!', validate:()=>document.getElementById('objetivo').value.trim().length>0 }
  ];

  let currentStep = 0; const wrapper = document.getElementById('wizardWrapper'); const centerForm = document.getElementById('centerForm'); const pipelineArea = document.getElementById('pipelineArea');

  function renderStep(n, direction='next'){
    const step = steps[n];
    const old = wrapper.querySelector('.form-card');
    if(old){ old.classList.add(direction==='next'?'slide-out-left':'slide-out-right'); setTimeout(()=>old.remove(),410); }
    const form = document.createElement('form');
    form.className = 'form-card ' + (direction==='next'?'slide-in-right':'slide-in-left');
    form.innerHTML = `
      <div class="progress-bar"><div class="progress-bar-inner" id="progress"></div></div>
      <span class="step-emoji">${step.emoji}</span>
      <div class="step-title">${step.title}</div>
      ${step.html}
      <div class="step-tip">${step.tip}</div>
      <div class="form-btn-row">
        <span class="step-count">Passo ${n+1} de ${steps.length}</span>
        <div style="display:flex;gap:12px;">
          ${n>0?`<button type="button" class="prev-btn">Voltar</button>`:''}
          <button type="button" class="next-btn" id="nextBtn" disabled>${n<steps.length-1?"Pr√≥xima":"Finalizar"}</button>
        </div>
      </div>`;
    wrapper.appendChild(form);
    form.querySelector('#progress').style.width = (n/(steps.length-1)*100) + '%';
    const enableNext = ()=>{ form.querySelector('.next-btn').disabled = !step.validate(); };
    form.querySelectorAll('select, input[type="radio"], input[type="text"]').forEach(el=>{ el.addEventListener('input', enableNext); el.addEventListener('change', enableNext); });
    enableNext();
    if(form.querySelector('.prev-btn')) form.querySelector('.prev-btn').onclick = ()=>{ currentStep--; renderStep(currentStep,'prev'); };
    form.querySelector('.next-btn').onclick = ()=>{
      if(!step.validate()) return;
      switch(currentStep){
        case 0: userAnswers.segmento = document.getElementById('segmento').value; break;
        case 1: userAnswers.usarIA = document.querySelector('input[name="usarIA"]:checked')?.value; break;
        case 2: userAnswers.produto = document.getElementById('produto').value.trim(); break;
        case 3: userAnswers.tipoCliente = document.querySelector('input[name="tipoCliente"]:checked')?.value; break;
        case 4: userAnswers.captaLead = Array.from(document.querySelectorAll('input[name="captaLead"]:checked')).map(el=>el.value); userAnswers.captaOutro = document.getElementById('captaOutro').value.trim(); break;
        case 5: { const el = document.querySelector('input[name="desafio"]:checked'); userAnswers.desafio = el?el.value:""; userAnswers.desafioOutro = document.getElementById('desafioOutro').value.trim(); } break;
        case 6: userAnswers.ciclo = document.querySelector('input[name="ciclo"]:checked')?.value; break;
        case 7: userAnswers.usaBot = document.querySelector('input[name="usaBot"]:checked')?.value; break;
        case 8: { const el = document.querySelector('input[name="sucesso"]:checked'); userAnswers.sucesso = el?el.value:""; userAnswers.sucessoOutro = document.getElementById('sucessoOutro').value.trim(); } break;
        case 9: userAnswers.objetivo = document.getElementById('objetivo').value.trim(); break;
      }
      if(currentStep < steps.length-1){ currentStep++; renderStep(currentStep,'next'); } else { mostrarPipelineFinal(); }
    };
  }
  renderStep(0,'next');

  function buildResumo(){
    const segmento = userAnswers.segmento; const usarIA = userAnswers.usarIA === 'sim';
    const captaSel = (userAnswers.captaLead||[]).filter(v=>v!=="Outro");
    let capta = captaSel.join(', ');
    if((userAnswers.captaLead||[]).includes('Outro') && userAnswers.captaOutro) capta = capta? capta+", "+userAnswers.captaOutro : userAnswers.captaOutro;
    if(!capta && userAnswers.captaOutro) capta = userAnswers.captaOutro;
    const desafio = userAnswers.desafio==="Outro" ? (userAnswers.desafioOutro||'Outro') : (userAnswers.desafio||'-');
    const sucesso = userAnswers.sucesso==="Outro" ? (userAnswers.sucessoOutro||'Outro') : (userAnswers.sucesso||'-');
    return `
      <div style="background:#0d1d32;border:1px solid #214266;padding:18px 24px 10px;border-radius:16px;margin-bottom:12px;box-shadow:0 10px 30px #00000033;">
        <h3 style="color:#cfe1ff;margin:0 0 10px 0;font-size:1.05rem;">Resumo das suas respostas</h3>
        <ul style="list-style:none;padding:0;line-height:1.8;margin:0;color:#a9c2e6">
          <li><b>Segmento:</b> ${segmentos.find(s=>s.val===segmento)?.txt||'-'}</li>
          <li><b>Funil:</b> ${usarIA? 'Com IA' : 'Tradicional'}</li>
          <li><b>Produto/Servi√ßo:</b> ${userAnswers.produto||'-'}</li>
          <li><b>Tipo de Cliente:</b> ${userAnswers.tipoCliente||'-'}</li>
          <li><b>Capta√ß√£o de Leads:</b> ${capta||'-'}</li>
          <li><b>Desafio atual:</b> ${desafio}</li>
          <li><b>Ciclo de vendas:</b> ${userAnswers.ciclo||'-'}</li>
          <li><b>Automa√ß√£o/Chatbot:</b> ${userAnswers.usaBot||'-'}</li>
          <li><b>M√©trica de sucesso:</b> ${sucesso}</li>
          <li><b>Objetivo principal:</b> ${userAnswers.objetivo||'-'}</li>
        </ul>
      </div>`;
  }

  // ===== Pipeline (com edi√ß√£o: criar/renomear/excluir) =====
  function mostrarPipelineFinal(){
    centerForm.style.display='none'; pipelineArea.style.display='block'; pipelineArea.innerHTML='';
    const segmento = userAnswers.segmento; const usarIA = userAnswers.usarIA==='sim';
    if(!currentPipeline){ currentPipeline = buildPipeline(segmento, usarIA); currentContext = {segmento, usarIA}; }

    const wrap = document.createElement('div'); wrap.className='pipeline-wrapper'; wrap.id='pipelineContent';
    wrap.innerHTML = buildResumo() + `<div class="pipeline-objetivo"><b>Objetivo principal:</b> ${userAnswers.objetivo||'-'}</div>`;

    const tb = document.createElement('div'); tb.className='board-toolbar';
    tb.innerHTML = `
      <button class="add-col-btn" id="addColBtn">+ Adicionar etapa</button>
      <div class="add-col-form" id="addColForm">
        <div class="form-row">
          <input type="text" id="newColName" placeholder="Nome da etapa">
          <select id="newColTipo"><option value="humano">Humano</option><option value="ia">IA</option></select>
        </div>
        <div class="form-row" style="justify-content:flex-end;">
          <button id="createCol">Criar</button>
          <button class="cancel" id="cancelAdd">Cancelar</button>
        </div>
      </div>`;
    wrap.appendChild(tb);

    const board = document.createElement('div'); board.className='pipeline-board';

    currentPipeline.forEach((col, idx)=>{
      const key = col.uid;
      const userNotes = (notasAdicionais[key]||[]).map((note,nidx)=>`
        <div class="kanban-card usernote">
          <span class="card-label">Nota</span>
          ${note}
          <button class="card-delete del-note-btn" title="Excluir nota" data-key="${key}" data-idx="${nidx}">&times;</button>
        </div>`).join('');
      const cardsHtml = (col.cards||[]).map(c=>`
        <div class="kanban-card ${col.tipo}"><span class="card-label">${col.tipo==='ia'?'IA':'Humano'}</span>${c}</div>`).join('') + userNotes;
      board.innerHTML += `
        <div class="pipeline-col col-${col.tipo}" data-idx="${idx}" style="border-top-color:${col.tipo==='ia'?'#2ed3b7':'#6b7bff'};">
          <div class="col-title"><span>${col.tipo==='ia'?icons.ia:icons.humano} ${col.nome}</span>
            <div class="col-actions">
              <button class="icon-btn col-rename" title="Renomear" data-idx="${idx}">‚úèÔ∏è</button>
              <button class="icon-btn col-delete" title="Excluir" data-idx="${idx}">üóëÔ∏è</button>
            </div>
          </div>
          <div class="kanban-cards" id="cardsCol${idx}">${cardsHtml}</div>
          <div class="add-note-btn kanban-add-btn" title="Adicionar nota" data-key="${key}" data-idx="${idx}">+</div>
          <div class="add-note-form" id="form_${key}" style="display:none;">
            <textarea id="note_${key}" rows="2" placeholder="Digite uma nota para esta etapa..."></textarea><br>
            <button onclick="addNote('${key}');return false;">Adicionar</button>
          </div>
        </div>`;
    });

    wrap.appendChild(board);
    const actions = document.createElement('div'); actions.className='pipeline-actions'; actions.innerHTML = `
      <button class="pdf-btn" id="pdfBtn">Gerar PDF</button>
      <button class="restart-btn" id="restartBtn">Refazer Pipeline</button>`; wrap.appendChild(actions);
    pipelineArea.appendChild(wrap);

    // Toolbar
    document.getElementById('addColBtn').onclick = ()=>{ document.getElementById('addColForm').style.display='block'; document.getElementById('newColName').focus(); };
    document.getElementById('cancelAdd').onclick = (e)=>{ e.preventDefault(); document.getElementById('addColForm').style.display='none'; };
    document.getElementById('createCol').onclick = (e)=>{ e.preventDefault(); const name=document.getElementById('newColName').value.trim(); const tipo=document.getElementById('newColTipo').value; if(!name) return alert('D√™ um nome para a etapa.'); currentPipeline.push({uid:genUid(),nome:name,tipo,cards:[]}); document.getElementById('addColForm').style.display='none'; document.getElementById('newColName').value=''; mostrarPipelineFinal(); };

    // Renomear/Excluir
    document.querySelectorAll('.col-rename').forEach(btn=>{ btn.onclick = ()=>{ const idx=parseInt(btn.getAttribute('data-idx')); const novo=prompt('Novo nome da etapa:', currentPipeline[idx].nome); if(novo&&novo.trim()){ currentPipeline[idx].nome=novo.trim(); mostrarPipelineFinal(); } }; });
    document.querySelectorAll('.col-delete').forEach(btn=>{ btn.onclick = ()=>{ const idx=parseInt(btn.getAttribute('data-idx')); const col=currentPipeline[idx]; if(confirm('Excluir esta etapa?')){ delete notasAdicionais[col.uid]; currentPipeline.splice(idx,1); mostrarPipelineFinal(); } }; });

    // PDF & Reiniciar
    document.getElementById('pdfBtn').onclick = ()=>{ document.querySelector('.pipeline-actions').style.display='none'; window.print(); setTimeout(()=>{ document.querySelector('.pipeline-actions').style.display=''; }, 500); };
    document.getElementById('restartBtn').onclick = ()=>{ pipelineArea.style.display='none'; centerForm.style.display='flex'; currentStep=0; currentPipeline=null; notasAdicionais={}; renderStep(0,'next'); };

    // Notas
    document.querySelectorAll('.add-note-btn').forEach(btn=>{ btn.onclick=function(){ let key=this.getAttribute('data-key'); document.querySelectorAll('.add-note-form').forEach(f=>f.style.display='none'); document.getElementById('form_'+key).style.display='block'; document.getElementById('note_'+key).focus(); } });
  }

  // Nota personalizada
  window.addNote = function(key){ const ta=document.getElementById('note_'+key); const nota=ta.value.trim(); if(!nota) return; if(!notasAdicionais[key]) notasAdicionais[key]=[]; notasAdicionais[key].push(nota); ta.value=''; document.getElementById('form_'+key).style.display='none'; mostrarPipelineFinal(); }
  document.addEventListener('click', function(e){ if(e.target.classList.contains('del-note-btn')){ let key=e.target.getAttribute('data-key'); let idx=parseInt(e.target.getAttribute('data-idx')); if(notasAdicionais[key]){ notasAdicionais[key].splice(idx,1); mostrarPipelineFinal(); } } });
</script>
</body>
</html>
